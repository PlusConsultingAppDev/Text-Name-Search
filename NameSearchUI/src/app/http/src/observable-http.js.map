{"version":3,"file":"observable-http.js","sourceRoot":"","sources":["../../../../modules/http/src/observable-http.ts"],"names":[],"mappings":"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","sourcesContent":["import { Router } from '@angular/router';\r\nimport { Observable } from 'rxjs/Observable';\r\nimport { PartialObserver } from 'rxjs/Observer';\r\nimport { Subscription } from 'rxjs/Subscription';\r\nimport { getToken, setToken, clearSessionParams } from '@iframework/core';\r\nimport { getSellerUrl, getPortal, getLogin, getChangePassword } from '@iframework/config';\r\nimport { ErrorHandler } from './error-handler';\r\nimport { ResponseHeader, ResponseItem } from './models';\r\nimport { getVRoot, clearVRoot } from './http-utils';\r\n\r\nexport class ObservableHttp extends Observable<any> {\r\n\r\n\tconstructor(private observable: Observable<ResponseItem>, private router: Router) {\r\n\t\tsuper();\r\n\t}\r\n\r\n\tpublic subscribe(observerOrNext?: PartialObserver<any> | ((value: any) => void), error?: (error: any) => void, complete?: () => void): Subscription {\r\n\t\treturn this.observable.subscribe(res => {\r\n\t\t\tlet header: ResponseHeader = res.header;\r\n\t\t\tif (header.status == 200) {\r\n\t\t\t\tif (header.token != getToken()) {\r\n\t\t\t\t\tsetToken(header.token);\r\n\t\t\t\t}\r\n\t\t\t\tif (observerOrNext) {\r\n\t\t\t\t\tif (window.isFunction(observerOrNext)) {\r\n\t\t\t\t\t\t(observerOrNext as ((value: any) => void))(res.responseDetails);\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\t(<any>(<PartialObserver<any>>observerOrNext)).next(res.responseDetails);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (header.status == 403) {\r\n\t\t\t\tlet portal: number = getPortal();\r\n\t\t\t\tlet isLoginRoute = false;\r\n\t\t\t\tlet vr: string = \"\";\r\n\t\t\t\tthis.router.routerState.root.queryParamMap.forEach(next => {\r\n\t\t\t\t\tvr = next.get(\"_vr\") || \"\";\r\n\t\t\t\t});\r\n\t\t\t\tlet returnUrl = this.router.routerState.snapshot.url;\r\n\t\t\t\tif (vr) {\r\n\t\t\t\t\treturnUrl = returnUrl.replace(\"?_vr=\" + vr, \"\").replace(\"&_vr=\" + vr, \"\");\r\n\t\t\t\t}\r\n\t\t\t\tlet queryParams = isLoginRoute ? null : { returnUrl: returnUrl };\r\n\t\t\t\tif (queryParams) {\r\n\t\t\t\t\tif (vr) {\r\n\t\t\t\t\t\tqueryParams[\"_vr\"] = vr;\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse if (portal != 0) {\r\n\t\t\t\t\t\tqueryParams[\"_vr\"] = getVRoot();\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\tlet login = getLogin();\r\n\t\t\t\tif (portal != 0) {\r\n\t\t\t\t\tisLoginRoute = this.router.url.toLowerCase().indexOf(\"/\" + login) != -1;\r\n\t\t\t\t}\r\n\t\t\t\tif (!isLoginRoute) {\r\n\t\t\t\t\tclearSessionParams();\r\n\t\t\t\t\tif (portal != 0) {\r\n\t\t\t\t\t\tthis.router.navigate([login], { queryParams: queryParams });\r\n\t\t\t\t\t}\r\n\t\t\t\t\telse {\r\n\t\t\t\t\t\twindow.location.href = getSellerUrl(login/* + \"?Goto=\" + this.router.routerState.snapshot.url*/);\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t\telse if (error) {\r\n\t\t\t\t\terror(res);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (header.status == 417) {\r\n\t\t\t\tsetToken(header.token);\r\n\t\t\t\tthis.router.navigate([getChangePassword()]);\r\n\t\t\t}\r\n\t\t\telse if (ErrorHandler.handleError) {\r\n\t\t\t\tErrorHandler.handleError(res, error);\r\n\t\t\t}\r\n\t\t\telse if (error) {\r\n\t\t\t\terror(res);\r\n\t\t\t}\r\n\t\t\telse {\r\n\t\t\t\tconsole.log(res);\r\n\t\t\t}\r\n\t\t}, err => ErrorHandler.handleError(err), () => complete && complete());\r\n\t}\r\n}"]}